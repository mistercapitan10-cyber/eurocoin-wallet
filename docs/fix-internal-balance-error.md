# Исправление ошибки "Failed to load internal balance snapshot"

## Проблема

В продакшене возникает ошибка:

```
[hooks:useInternalBalance] Failed to load balance: Error: Failed to load internal balance snapshot
```

## Возможные причины

### 1. Проблема с подключением к базе данных

- `DATABASE_URL` не настроен в продакшене
- База данных недоступна
- Проблемы с подключением к PostgreSQL

### 2. Таблицы не созданы

- Миграции не применены в продакшн БД
- Таблицы `internal_wallets`, `internal_balances`, `internal_ledger` не существуют

### 3. Проблема с сессией/аутентификацией

- `userId` не передается из сессии
- Сессия не работает правильно в продакшене
- Проблемы с NextAuth конфигурацией

### 4. Проблема с пользователем

- Пользователь не зарегистрирован в системе
- `walletAddress` не найден в базе данных

## Что исправлено

### 1. Улучшена обработка ошибок

- Добавлено детальное логирование на каждом этапе
- Ошибки теперь возвращают детали (`details` поле)
- Разделена обработка ошибок БД и ошибок snapshot

### 2. Добавлено логирование

- Логирование запросов и параметров
- Логирование успешных операций
- Детальное логирование ошибок с stack trace

## Диагностика в продакшене

### Шаг 1: Проверьте логи сервера

После деплоя проверьте логи в консоли продакшена (Vercel/другой хостинг). Ищите строки с префиксом `[api:internal-balance]`:

```
[api:internal-balance] Request received: { hasSession: true, userId: "...", ... }
[api:internal-balance] Loading snapshot: { userId: "...", walletAddress: "..." }
[api:internal-balance] Snapshot loaded successfully: { walletId: "...", ... }
```

Или ошибки:

```
[api:internal-balance] Database error when fetching user: ...
[api:internal-balance] Failed to load balance snapshot: ...
```

### Шаг 2: Проверьте переменные окружения

Убедитесь, что в продакшене настроены:

```env
DATABASE_URL=postgresql://user:password@host:5432/database
# или
DATABASE_POSTGRES_URL=postgresql://user:password@host:5432/database
```

### Шаг 3: Проверьте миграции

Убедитесь, что миграции применены в продакшн БД:

```sql
-- Проверка существования таблиц
SELECT table_name
FROM information_schema.tables
WHERE table_name IN ('internal_wallets', 'internal_balances', 'internal_ledger', 'withdraw_requests');
```

Если таблиц нет, примените миграции:

```bash
npm run db:init
npm run db:migrate
```

### Шаг 4: Проверьте пользователя

Убедитесь, что пользователь зарегистрирован:

```sql
-- Проверка пользователя
SELECT id, wallet_address, auth_type FROM users WHERE wallet_address = '0x...';
```

## Решение проблем

### Если ошибка "Database error while fetching user"

1. Проверьте `DATABASE_URL` в продакшене
2. Проверьте доступность базы данных
3. Проверьте, что пользователь зарегистрирован

### Если ошибка "Internal wallet identifier requires userId"

1. Проверьте, что сессия работает правильно
2. Проверьте NextAuth конфигурацию
3. Убедитесь, что пользователь аутентифицирован

### Если ошибка "Failed to load internal balance snapshot"

1. Проверьте логи для деталей ошибки
2. Проверьте, что таблицы созданы
3. Проверьте подключение к базе данных

## Временное решение

Если проблема критична и нужно быстро исправить:

1. **Отключите отображение внутреннего баланса** временно (закомментируйте компонент)
2. **Или добавьте fallback** - показывайте пустой баланс вместо ошибки

Но лучше исправить корневую причину, используя логи для диагностики.

## После исправления

После применения исправлений:

1. **Перезапустите приложение** в продакшене
2. **Проверьте логи** - должны появиться детальные сообщения
3. **Проверьте работу** - баланс должен загружаться без ошибок

## Мониторинг

Рекомендуется настроить мониторинг ошибок:

- Sentry или аналогичный сервис
- Логирование в Vercel/другой хостинг
- Алерты на критические ошибки
