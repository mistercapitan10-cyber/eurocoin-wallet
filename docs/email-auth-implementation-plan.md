# План реализации входа через почту

## Обзор

Реализация полноценного входа через email с отправкой magic link на почту. После перехода по ссылке пользователь должен попасть на главную страницу с контентом сайта (обмен, заявки и т.д.).

## Текущее состояние

### Что уже есть:

- ✅ NextAuth настроен с провайдером Email
- ✅ Компонент `EmailSignInForm` готов к использованию
- ✅ Resend настроен для отправки email
- ✅ Middleware проверяет NextAuth сессии
- ✅ Главная страница (`/`) показывает весь контент (обмен, заявки)

### Что нужно исправить:

- ❌ Email провайдер отключен в development режиме
- ❌ Нет явной настройки callback URL после входа
- ❌ Нужно убедиться, что middleware корректно обрабатывает email сессии

## Фазы реализации

### Фаза 1: Включение email провайдера в development

**Задачи:**

1. Изменить условие в `lib/auth.ts` чтобы email провайдер работал в development
2. Добавить проверку наличия `RESEND_API_KEY` с понятным сообщением
3. Убедиться, что `SENDER_EMAIL` настроен

**Изменения:**

- `lib/auth.ts`: убрать проверку `NODE_ENV !== "production"` или сделать её опциональной через переменную окружения

**Ожидаемый результат:**

- Email провайдер работает в development
- При отсутствии ключей показываются понятные предупреждения

---

### Фаза 2: Настройка callback URL и редиректов

**Задачи:**

1. Настроить правильный `callbackUrl` в компоненте `EmailSignInForm`
2. Обновить callback в NextAuth для редиректа на главную после входа
3. Убедиться, что после перехода по ссылке из email пользователь попадает на `/`

**Изменения:**

- `components/auth/email-signin-form.tsx`: убедиться что `callbackUrl="/"` правильно передается
- `lib/auth.ts`: проверить callback `redirect` для корректного редиректа

**Ожидаемый результат:**

- После входа по email пользователь редиректится на главную страницу
- Сессия устанавливается корректно

---

### Фаза 3: Проверка middleware

**Задачи:**

1. Убедиться, что middleware корректно определяет NextAuth сессию
2. Проверить, что аутентифицированные пользователи не редиректятся обратно на `/login`
3. Убедиться, что неаутентифицированные пользователи редиректятся на `/login`

**Изменения:**

- `middleware.ts`: проверить логику определения аутентификации
- Возможно, добавить больше логирования для отладки

**Ожидаемый результат:**

- Middleware корректно обрабатывает email аутентификацию
- Нет лишних редиректов

---

### Фаза 4: Улучшение UX

**Задачи:**

1. Улучшить сообщения об успешной отправке email
2. Добавить информацию о проверке почты
3. Улучшить обработку ошибок
4. Добавить переводы для всех сообщений

**Изменения:**

- `components/auth/email-signin-form.tsx`: улучшить сообщения
- `lib/i18n/translations.ts`: добавить переводы

**Ожидаемый результат:**

- Понятные сообщения на русском и английском
- Хороший UX при отправке и обработке email

---

## Переменные окружения

Для работы email аутентификации нужны:

```env
# Resend API Key (required)
RESEND_API_KEY=re_xxxxxxxxxxxxxxxxxxxxx

# Email Configuration
SENDER_EMAIL=noreply@yourdomain.com
# или для тестирования:
# SENDER_EMAIL=noreply@resend.dev

# Enable email auth (optional, для явного включения)
ENABLE_EMAIL_AUTH=true
```

## Тестирование

### Локальное тестирование:

1. Запустить `npm run dev`
2. Перейти на `/login`
3. Ввести email и нажать "Send sign-in link"
4. Проверить почту и перейти по ссылке
5. Убедиться, что попали на главную страницу

### Проверка:

- ✅ Email отправляется на указанный адрес
- ✅ Ссылка в email работает
- ✅ После перехода по ссылке устанавливается сессия
- ✅ Пользователь попадает на главную страницу
- ✅ Middleware не редиректит обратно на `/login`
- ✅ Все разделы сайта доступны (обмен, заявки)

## Примечания

- Email провайдер использует magic link (без пароля)
- Ссылка действует 24 часа (настроено в `maxAge`)
- Используется Resend для отправки email (уже настроен в проекте)
- В development можно использовать `noreply@resend.dev` без верификации домена

---

## Статус реализации

✅ **Все фазы выполнены**

### Выполненные изменения:

1. **lib/auth.ts**:
   - Email провайдер теперь работает в development режиме (если установлен `RESEND_API_KEY`)
   - Улучшена логика проверки наличия ключей с понятными сообщениями
   - Добавлена возможность отключить через `DISABLE_EMAIL_AUTH=true`

2. **components/auth/email-signin-form.tsx**:
   - Улучшены сообщения об успешной отправке email (продолжительность 5 секунд)
   - Форма автоматически сворачивается через 2 секунды после успешной отправки
   - Callback URL уже настроен на главную страницу (`/`)

3. **middleware.ts**:
   - Уже корректно обрабатывает NextAuth сессии (включая email аутентификацию)
   - Проверяет наличие cookie `next-auth.session-token` для определения аутентификации

### Что нужно для работы:

Установите следующие переменные в `.env.local`:

```env
RESEND_API_KEY=re_xxxxxxxxxxxxxxxxxxxxx
SENDER_EMAIL=noreply@resend.dev
# или ваш домен:
# SENDER_EMAIL=noreply@yourdomain.com
```

### Как протестировать:

1. Установите `RESEND_API_KEY` в `.env.local`
2. Запустите `npm run dev`
3. Перейдите на `/login`
4. Нажмите "Войти по электронной почте"
5. Введите email и нажмите "Отправить ссылку для входа"
6. Проверьте почту и перейдите по ссылке
7. После перехода по ссылке вы должны попасть на главную страницу с контентом (обмен, заявки и т.д.)
