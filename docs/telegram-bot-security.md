# –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å Telegram-–±–æ—Ç–∞

## –û–±–∑–æ—Ä

Telegram-–±–æ—Ç —Ç–µ–ø–µ—Ä—å –∑–∞—â–∏—â–µ–Ω –æ—Ç –Ω–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞. –î–æ—Å—Ç—É–ø –∫ –±–æ—Ç—É –∏–º–µ–µ—Ç —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å User ID, —É–∫–∞–∑–∞–Ω–Ω—ã–º –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è `TELEGRAM_ALLOWED_USER_ID`.

## –¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

**–†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:** User ID `8579138037`

–≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–º–µ–µ—Ç –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º —Ñ—É–Ω–∫—Ü–∏—è–º –±–æ—Ç–∞:
- –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –∑–∞—è–≤–æ–∫ (–æ–±–º–µ–Ω, –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ)
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞–º–∏ –∑–∞—è–≤–æ–∫
- –î–æ—Å—Ç—É–ø –∫ —á–∞—Ç–∞–º –ø–æ–¥–¥–µ—Ä–∂–∫–∏
- –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
- –†–∞—Å—Å—ã–ª–∫–∏ (–µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–ª—è–µ—Ç—Å—è MANAGER)

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∑–∞—â–∏—Ç–∞

### 1. Middleware —Ñ—É–Ω–∫—Ü–∏–∏

–í —Ñ–∞–π–ª–µ `app/api/telegram-webhook/route.ts` —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –¥–≤–µ —Ñ—É–Ω–∫—Ü–∏–∏:

```typescript
// –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
function isAuthorizedUser(userId: number): boolean

// –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
async function checkAccess(ctx: any): Promise<boolean>
```

### 2. –ó–∞—â–∏—â–µ–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

#### –ö–æ–º–∞–Ω–¥—ã (–∑–∞—â–∏—â–µ–Ω—ã):
- `/start` - –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
- `/help` - —Å–ø—Ä–∞–≤–∫–∞
- `/list` - —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∑–∞—è–≤–æ–∫
- `/exchange` - –∑–∞—è–≤–∫–∏ –Ω–∞ –æ–±–º–µ–Ω
- `/internal` - –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∑–∞—è–≤–∫–∏
- `/chats` - –∞–∫—Ç–∏–≤–Ω—ã–µ —á–∞—Ç—ã
- `/details <ID>` - –¥–µ—Ç–∞–ª–∏ –∑–∞—è–≤–∫–∏
- `/subscribe` - –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Ä–∞—Å—Å—ã–ª–∫—É
- `/unsubscribe` - –æ—Ç–ø–∏—Å–∫–∞ –æ—Ç —Ä–∞—Å—Å—ã–ª–∫–∏
- `/newsletter` - –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏
- `/cancel` - –æ—Ç–º–µ–Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏

#### –ö–æ–º–∞–Ω–¥—ã (–¥–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ–º):
- `/myid` - —É–∑–Ω–∞—Ç—å —Å–≤–æ–π User ID

> ‚ö†Ô∏è **–í–∞–∂–Ω–æ:** –ö–æ–º–∞–Ω–¥–∞ `/myid` –Ω–∞–º–µ—Ä–µ–Ω–Ω–æ –æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –¥–æ—Å—Ç—É–ø–Ω–æ–π –≤—Å–µ–º, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥–ª–∏ —É–∑–Ω–∞—Ç—å —Å–≤–æ–π ID –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –¥–æ—Å—Ç—É–ø–∞.

#### Callback handlers (–∫–Ω–æ–ø–∫–∏):
- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞–º–∏ –∑–∞—è–≤–æ–∫
- –ö–Ω–æ–ø–∫–∏ —á–∞—Ç–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏
- –í—Å–µ inline-–∫–Ω–æ–ø–∫–∏

#### Text handler:
- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–æ—Ç–≤–µ—Ç—ã –≤ —á–∞—Ç–∞—Ö, —Ä–∞—Å—Å—ã–ª–∫–∏)

### 3. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –Ω–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞:

```
[telegram-webhook] üö´ Unauthorized access attempt from User ID: 123456789
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (User ID: 8579138037)

1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –±–æ—Ç—É –∫–æ–º–∞–Ω–¥—É `/start`
2. **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** –ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ–º —Å –º–µ–Ω—é –∫–æ–º–∞–Ω–¥
3. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É `/list`
4. **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** –ë–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∑–∞—è–≤–æ–∫

### –¢–µ—Å—Ç 2: –ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–ª—é–±–æ–π –¥—Ä—É–≥–æ–π User ID)

1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –±–æ—Ç—É –∫–æ–º–∞–Ω–¥—É `/start`
2. **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
   ```
   üîí –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –±–æ—Ç—É.

   –≠—Ç–æ—Ç –±–æ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤.
   –ï—Å–ª–∏ –≤—ã —Å—á–∏—Ç–∞–µ—Ç–µ, —á—Ç–æ —ç—Ç–æ –æ—à–∏–±–∫–∞, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –≤–ª–∞–¥–µ–ª—å—Ü—É –±–æ—Ç–∞.
   ```
3. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ª—é–±—É—é –¥—Ä—É–≥—É—é –∫–æ–º–∞–Ω–¥—É
4. **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** –¢–æ –∂–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç–∫–∞–∑–µ –≤ –¥–æ—Å—Ç—É–ø–µ

### –¢–µ—Å—Ç 3: –ö–æ–º–∞–Ω–¥–∞ /myid (–¥–æ—Å—Ç—É–ø–Ω–∞ –≤—Å–µ–º)

1. –õ—é–±–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `/myid`
2. **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** –ë–æ—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç User ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   ```
   üÜî –í–∞—à Chat ID: 123456789

   üë§ Username: @username
   üë§ Name: FirstName

   üìù –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ—Ç Chat ID –≤ .env.local:
   TELEGRAM_ALLOWED_USER_ID=123456789
   ```

### –¢–µ—Å—Ç 4: Inline-–∫–Ω–æ–ø–∫–∏

1. –ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç –Ω–∞ –ª—é–±—É—é inline-–∫–Ω–æ–ø–∫—É
2. **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** –í—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ "üîí –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞"

## –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### –ü–µ—Ä–µ–¥–∞—á–∞ –¥–æ—Å—Ç—É–ø–∞ –¥—Ä—É–≥–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

1. –ü–æ–ø—Ä–æ—Å–∏—Ç–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å `/myid` –±–æ—Ç—É
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–π User ID
3. –û–±–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –≤ `.env` –∏ `.env.local`:
   ```env
   TELEGRAM_ALLOWED_USER_ID=–Ω–æ–≤—ã–π_user_id
   ```
4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä:
   ```bash
   npm run dev  # –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
   # –∏–ª–∏
   npm run build && npm run start  # –¥–ª—è production
   ```

### –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º

–ï—Å–ª–∏ –≤ –±—É–¥—É—â–µ–º –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–∞—Ç—å –¥–æ—Å—Ç—É–ø –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –ª—é–¥—è–º:

1. –ò–∑–º–µ–Ω–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –Ω–∞ —Å–ø–∏—Å–æ–∫ ID (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):
   ```env
   TELEGRAM_ALLOWED_USER_IDS=8579138037,123456789,987654321
   ```

2. –û–±–Ω–æ–≤–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é `isAuthorizedUser` –≤ `app/api/telegram-webhook/route.ts`:
   ```typescript
   function isAuthorizedUser(userId: number): boolean {
     const allowedUserIds = process.env.TELEGRAM_ALLOWED_USER_IDS?.split(',') || [];

     if (allowedUserIds.length === 0) {
       console.warn('[telegram-webhook] ‚ö†Ô∏è  TELEGRAM_ALLOWED_USER_IDS is not set!');
       return process.env.NODE_ENV !== 'production';
     }

     return allowedUserIds.includes(userId.toString());
   }
   ```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –≤ Production

### –í–∞–∂–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º:

1. ‚úÖ `TELEGRAM_ALLOWED_USER_ID` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ production `.env`
2. ‚úÖ –ó–Ω–∞—á–µ–Ω–∏–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –Ω—É–∂–Ω–æ–º—É User ID
3. ‚úÖ `.env` —Ñ–∞–π–ª—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ `.gitignore`
4. ‚úÖ –°–µ–∫—Ä–µ—Ç–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã –Ω–µ –ø–æ–ø–∞–ª–∏ –≤ Git

### –ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π:

- **Development:** –ë–æ—Ç –≤—ã–¥–∞–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, –Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
- **Production:** –ë–æ—Ç –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

```typescript
// –ò–∑ —Ñ—É–Ω–∫—Ü–∏–∏ isAuthorizedUser()
return process.env.NODE_ENV !== 'production';
```

## –õ–æ–≥–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

–°–ª–µ–¥–∏—Ç–µ –∑–∞ —ç—Ç–∏–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –≤ –ª–æ–≥–∞—Ö:

### ‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

```
[telegram-webhook] ‚ö†Ô∏è  TELEGRAM_ALLOWED_USER_ID is not set!
Bot is open to all users. Add it to .env.local:
TELEGRAM_ALLOWED_USER_ID=your_user_id
```
**–î–µ–π—Å—Ç–≤–∏–µ:** –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é!

### üö´ –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏

```
[telegram-webhook] üö´ Unauthorized access attempt from User ID: 123456789
```
**–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:** –ö—Ç–æ-—Ç–æ –ø—ã—Ç–∞–ª—Å—è –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –±–æ—Ç—É

### ‚ùå –û—à–∏–±–∫–∏

```
[telegram-webhook] ‚ö†Ô∏è  No user ID in context
```
**–î–µ–π—Å—Ç–≤–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å webhook updates

## –†–µ–∑—é–º–µ

- ‚úÖ –ë–æ—Ç –∑–∞—â–∏—â–µ–Ω –æ—Ç –Ω–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
- ‚úÖ –î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ —É User ID: `8579138037`
- ‚úÖ –í—Å–µ –∫–æ–º–∞–Ω–¥—ã –∏ –∫–Ω–æ–ø–∫–∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
- ‚úÖ –ö–æ–º–∞–Ω–¥–∞ `/myid` –¥–æ—Å—Ç—É–ø–Ω–∞ –≤—Å–µ–º –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è ID
- ‚úÖ –õ–æ–≥–∏—Ä—É—é—Ç—Å—è –ø–æ–ø—ã—Ç–∫–∏ –Ω–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
- ‚úÖ –õ–µ–≥–∫–æ –ø–µ—Ä–µ–¥–∞—Ç—å –¥–æ—Å—Ç—É–ø –¥—Ä—É–≥–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
