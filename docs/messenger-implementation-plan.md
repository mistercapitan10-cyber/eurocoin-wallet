# –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞ —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π Telegram –±–æ—Ç–∞

## üìã –û–±–∑–æ—Ä

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞ –¥–ª—è –æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —á–µ—Ä–µ–∑ —Å–∞–π—Ç –∏ Telegram –±–æ—Ç–∞ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤.

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:**

- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram –æ –Ω–æ–≤—ã—Ö –∑–∞—è–≤–∫–∞—Ö (–æ–±–º–µ–Ω —Ç–æ–∫–µ–Ω–æ–≤ –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ)
- –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –∏–∑ Telegram –±–æ—Ç–∞
- –ü—Ä–æ—Å–º–æ—Ç—Ä –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π) –∏–∑ Telegram
- –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –Ω–∞ —Å–∞–π—Ç–µ
- –ü–æ–∫–∞–∑ —Å—Ç–∞—Ç—É—Å–∞ "–ø–µ—á–∞—Ç–∞–µ—Ç..." –ø—Ä–∏ –Ω–∞–±–æ—Ä–µ —Ç–µ–∫—Å—Ç–∞ –∞–¥–º–∏–Ω–æ–º
- –ó–≤—É–∫–æ–≤–æ–π —Å–∏–≥–Ω–∞–ª –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è

### –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç        | –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è                           | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                                   |
| ---------------- | ------------------------------------ | -------------------------------------------- |
| **Backend API**  | Next.js API Routes                   | –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π, WebSocket –¥–ª—è real-time |
| **Database**     | PostgreSQL                           | –•—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ —Å–µ—Å—Å–∏–π                  |
| **Telegram Bot** | Telegraf                             | –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤                |
| **Real-time**    | Server-Sent Events (SSE) –∏–ª–∏ Polling | –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ            |
| **WebSocket**    | –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: Socket.io               | –î–ª—è —Å—Ç–∞—Ç—É—Å–∞ "–ø–µ—á–∞—Ç–∞–µ—Ç..."                    |
| **Audio**        | HTML5 Audio API                      | –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–≤—É–∫–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π           |

---

## üìä –°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç–∞–±–ª–∏—Ü

#### 1. –¢–∞–±–ª–∏—Ü–∞ `support_messages` (–Ω–æ–≤–∞—è)

```sql
CREATE TABLE IF NOT EXISTS support_messages (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id UUID REFERENCES chatbot_sessions(id) ON DELETE CASCADE,
  user_wallet_address VARCHAR(42) NOT NULL,
  type VARCHAR(20) NOT NULL CHECK (type IN ('user', 'admin', 'system')),
  text TEXT NOT NULL,
  admin_id BIGINT, -- Telegram chat_id –∞–¥–º–∏–Ω–∞
  admin_username VARCHAR(255), -- –ò–º—è –∞–¥–º–∏–Ω–∞ –∏–∑ Telegram
  is_read BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_support_messages_session ON support_messages(session_id);
CREATE INDEX IF NOT EXISTS idx_support_messages_wallet ON support_messages(user_wallet_address);
CREATE INDEX IF NOT EXISTS idx_support_messages_created ON support_messages(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_support_messages_unread ON support_messages(user_wallet_address, is_read) WHERE is_read = FALSE;
```

#### 2. –¢–∞–±–ª–∏—Ü–∞ `typing_indicators` (–Ω–æ–≤–∞—è)

```sql
CREATE TABLE IF NOT EXISTS typing_indicators (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_wallet_address VARCHAR(42) NOT NULL,
  admin_id BIGINT NOT NULL,
  admin_username VARCHAR(255),
  is_typing BOOLEAN DEFAULT TRUE,
  started_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  expires_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP + INTERVAL '30 seconds'
);

CREATE INDEX IF NOT EXISTS idx_typing_indicators_wallet ON typing_indicators(user_wallet_address);
CREATE INDEX IF NOT EXISTS idx_typing_indicators_expires ON typing_indicators(expires_at);
```

#### 3. –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ `chatbot_sessions`

–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è:

```sql
ALTER TABLE chatbot_sessions ADD COLUMN IF NOT EXISTS last_admin_message_at TIMESTAMP;
ALTER TABLE chatbot_sessions ADD COLUMN IF NOT EXISTS unread_count INTEGER DEFAULT 0;
```

---

## üîÑ –ü–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö

### 1. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –∑–∞—è–≤–∫–∞—Ö –≤ Telegram

```
User submits request
  ‚Üì
API endpoint (submit-exchange-request / submit-request)
  ‚Üì
Save to database (exchange_requests / internal_requests)
  ‚Üì
Send notification to Telegram bot
  ‚Üì
Admin sees notification with buttons:
  - "–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ" ‚Üí opens chat
  - "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é" ‚Üí shows last 10 messages
```

**–§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:**

- `app/api/submit-exchange-request/route.ts` - –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- `app/api/submit-request/route.ts` - –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- `app/api/telegram-webhook/route.ts` - –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–æ–≤—ã—Ö –∫–æ–º–∞–Ω–¥

---

### 2. –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ Telegram –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

```
Admin types message in Telegram bot
  ‚Üì
Bot handler processes message
  ‚Üì
Save to support_messages table
  ‚Üì
WebSocket/SSE sends to frontend
  ‚Üì
User sees message in chat window
  ‚Üì
Play notification sound
```

**–ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã:**

- `app/api/support/send-admin-message/route.ts` - API –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
- `app/api/support/get-typing-status/route.ts` - API –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ "–ø–µ—á–∞—Ç–∞–µ—Ç"

---

### 3. –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —Å —Å–∞–π—Ç–∞ –∞–¥–º–∏–Ω—É –≤ Telegram

```
User types message on website
  ‚Üì
API: /api/support/send-user-message
  ‚Üì
Save to support_messages table
  ‚Üì
Send notification to Telegram bot (admin)
  ‚Üì
Admin receives message in Telegram
```

**–ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã:**

- `app/api/support/send-user-message/route.ts` - API –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
- `lib/telegram/notify-admin.ts` - –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ Telegram

---

### 4. –ü—Ä–æ—Å–º–æ—Ç—Ä –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞ –∏–∑ Telegram

```
Admin clicks "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞"
  ‚Üì
Bot sends callback with wallet_address
  ‚Üì
API: /api/support/get-chat-history
  ‚Üì
Query last 10 messages from database
  ‚Üì
Format and send to admin in Telegram
```

**–ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã:**

- `app/api/support/get-chat-history/route.ts` - API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏
- –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ `app/api/telegram-webhook/route.ts` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ callback

---

### 5. –°—Ç–∞—Ç—É—Å "–ø–µ—á–∞—Ç–∞–µ—Ç..."

```
Admin starts typing in Telegram
  ‚Üì
Bot handler detects typing
  ‚Üì
Update typing_indicators table
  ‚Üì
Frontend polls /api/support/get-typing-status
  ‚Üì
Show "–ê–¥–º–∏–Ω –ø–µ—á–∞—Ç–∞–µ—Ç..." in chat window
```

**–ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã:**

- `app/api/support/set-typing/route.ts` - API –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å—Ç–∞—Ç—É—Å–∞
- Hook: `hooks/use-typing-indicator.ts` - —Ö—É–∫ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

### –ù–æ–≤—ã–µ API endpoints

```
app/api/
‚îú‚îÄ‚îÄ support/
‚îÇ   ‚îú‚îÄ‚îÄ send-user-message/route.ts      # –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
‚îÇ   ‚îú‚îÄ‚îÄ send-admin-message/route.ts     # –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –∞–¥–º–∏–Ω–æ–º
‚îÇ   ‚îú‚îÄ‚îÄ get-messages/route.ts           # –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π (–æ–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π)
‚îÇ   ‚îú‚îÄ‚îÄ get-chat-history/route.ts       # –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ –¥–ª—è Telegram
‚îÇ   ‚îú‚îÄ‚îÄ set-typing/route.ts             # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ "–ø–µ—á–∞—Ç–∞–µ—Ç"
‚îÇ   ‚îú‚îÄ‚îÄ get-typing-status/route.ts      # –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ "–ø–µ—á–∞—Ç–∞–µ—Ç"
‚îÇ   ‚îî‚îÄ‚îÄ mark-read/route.ts              # –û—Ç–º–µ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–≥–æ
‚îî‚îÄ‚îÄ telegram/
    ‚îî‚îÄ‚îÄ notify-admin/route.ts           # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞ –æ –Ω–æ–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
```

### –ù–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

```
components/
‚îú‚îÄ‚îÄ support/
‚îÇ   ‚îú‚îÄ‚îÄ support-messenger.tsx           # –ì–ª–∞–≤–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞
‚îÇ   ‚îú‚îÄ‚îÄ message-list.tsx                # –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
‚îÇ   ‚îú‚îÄ‚îÄ message-item.tsx                # –≠–ª–µ–º–µ–Ω—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ typing-indicator.tsx            # –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä "–ø–µ—á–∞—Ç–∞–µ—Ç..."
‚îÇ   ‚îî‚îÄ‚îÄ notification-sound.tsx         # –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –∑–≤—É–∫–∞
‚îî‚îÄ‚îÄ profile/
    ‚îî‚îÄ‚îÄ support-chat-modal.tsx          # –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–∞—Ç–∞ (–æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ –∫–ª–∏–∫—É –Ω–∞ –∫–æ–Ω–≤–µ—Ä—Ç)
```

### –ù–æ–≤—ã–µ —Ö—É–∫–∏

```
hooks/
‚îú‚îÄ‚îÄ use-support-messages.ts             # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏
‚îú‚îÄ‚îÄ use-typing-indicator.ts             # –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ "–ø–µ—á–∞—Ç–∞–µ—Ç"
‚îî‚îÄ‚îÄ use-notification-sound.ts           # –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–≤—É–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
```

### –£—Ç–∏–ª–∏—Ç—ã

```
lib/
‚îú‚îÄ‚îÄ telegram/
‚îÇ   ‚îú‚îÄ‚îÄ notify-admin.ts                 # –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∞–¥–º–∏–Ω—É
‚îÇ   ‚îî‚îÄ‚îÄ bot-helpers.ts                  # –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –±–æ—Ç–∞
‚îî‚îÄ‚îÄ database/
    ‚îî‚îÄ‚îÄ support-queries.ts              # SQL –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏
```

---

## üîß –î–µ—Ç–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ —ç—Ç–∞–ø–∞–º

### –≠—Ç–∞–ø 1: –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (1-2 —á–∞—Å–∞)

**–ó–∞–¥–∞—á–∏:**

1. –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è –Ω–æ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü
2. –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã
3. –°–æ–∑–¥–∞—Ç—å –∏–Ω–¥–µ–∫—Å—ã
4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é

**–§–∞–π–ª—ã:**

- `lib/database/migrations/add-support-messenger.sql`
- `lib/database/support-queries.ts`

**SQL –º–∏–≥—Ä–∞—Ü–∏—è:**

```sql
-- –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã support_messages
CREATE TABLE IF NOT EXISTS support_messages (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id UUID REFERENCES chatbot_sessions(id) ON DELETE CASCADE,
  user_wallet_address VARCHAR(42) NOT NULL,
  type VARCHAR(20) NOT NULL CHECK (type IN ('user', 'admin', 'system')),
  text TEXT NOT NULL,
  admin_id BIGINT,
  admin_username VARCHAR(255),
  is_read BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- –ò–Ω–¥–µ–∫—Å—ã
CREATE INDEX IF NOT EXISTS idx_support_messages_session ON support_messages(session_id);
CREATE INDEX IF NOT EXISTS idx_support_messages_wallet ON support_messages(user_wallet_address);
CREATE INDEX IF NOT EXISTS idx_support_messages_created ON support_messages(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_support_messages_unread ON support_messages(user_wallet_address, is_read) WHERE is_read = FALSE;

-- –¢–∞–±–ª–∏—Ü–∞ typing_indicators
CREATE TABLE IF NOT EXISTS typing_indicators (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_wallet_address VARCHAR(42) NOT NULL,
  admin_id BIGINT NOT NULL,
  admin_username VARCHAR(255),
  is_typing BOOLEAN DEFAULT TRUE,
  started_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  expires_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP + INTERVAL '30 seconds'
);

CREATE INDEX IF NOT EXISTS idx_typing_indicators_wallet ON typing_indicators(user_wallet_address);
CREATE INDEX IF NOT EXISTS idx_typing_indicators_expires ON typing_indicators(expires_at);

-- –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ chatbot_sessions
ALTER TABLE chatbot_sessions ADD COLUMN IF NOT EXISTS last_admin_message_at TIMESTAMP;
ALTER TABLE chatbot_sessions ADD COLUMN IF NOT EXISTS unread_count INTEGER DEFAULT 0;

-- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ –ø–µ—á–∞—Ç–∞–Ω–∏—è
CREATE OR REPLACE FUNCTION cleanup_expired_typing_indicators()
RETURNS void AS $$
BEGIN
  DELETE FROM typing_indicators WHERE expires_at < NOW();
END;
$$ LANGUAGE plpgsql;
```

---

### –≠—Ç–∞–ø 2: –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Telegram (2-3 —á–∞—Å–∞)

**–ó–∞–¥–∞—á–∏:**

1. –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –Ω–æ–≤—ã—Ö –∑–∞—è–≤–∫–∞—Ö
2. –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –∞–¥–º–∏–Ω—É
3. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è Telegram

**–§–∞–π–ª:** `lib/telegram/notify-admin.ts`

```typescript
import { Telegraf, Markup } from "telegraf";

const bot = new Telegraf(process.env.TELEGRAM_API_KEY!);

/**
 * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–æ–≤–æ–π –∑–∞—è–≤–∫–µ –Ω–∞ –æ–±–º–µ–Ω
 */
export async function notifyNewExchangeRequest(request: {
  id: string;
  walletAddress: string;
  email: string;
  tokenAmount: string;
  fiatAmount: string;
}) {
  const adminChatId = process.env.TELEGRAM_ADMIN_CHAT_ID;
  if (!adminChatId) return;

  const message = `
üîî *–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ –æ–±–º–µ–Ω —Ç–æ–∫–µ–Ω–æ–≤*

üìã *ID –∑–∞—è–≤–∫–∏:* EX-${request.id}
üíº *–ö–æ—à–µ–ª–µ–∫:* \`${request.walletAddress}\`
üìß *Email:* ${request.email}
üí∞ *–°—É–º–º–∞ —Ç–æ–∫–µ–Ω–æ–≤:* ${request.tokenAmount}
üíµ *–°—É–º–º–∞ —Ñ–∏–∞—Ç–∞:* ${request.fiatAmount}

[–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–µ—Ç–∞–ª–∏](#)
  `.trim();

  const keyboard = Markup.inlineKeyboard([
    [
      Markup.button.callback("üí¨ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ", `msg_${request.walletAddress}`),
      Markup.button.callback("üìú –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞", `history_${request.walletAddress}`),
    ],
    [Markup.button.url("üìã –î–µ—Ç–∞–ª–∏ –∑–∞—è–≤–∫–∏", `/details EX-${request.id}`)],
  ]);

  await bot.telegram.sendMessage(adminChatId, message, {
    parse_mode: "Markdown",
    ...keyboard,
  });
}

/**
 * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–æ–≤–æ–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –∑–∞—è–≤–∫–µ
 */
export async function notifyNewInternalRequest(request: {
  id: string;
  requester: string;
  walletAddress?: string;
  department: string;
  requestType: string;
  priority: string;
}) {
  const adminChatId = process.env.TELEGRAM_ADMIN_CHAT_ID;
  if (!adminChatId) return;

  const message = `
üîî *–ù–æ–≤–∞—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –∑–∞—è–≤–∫–∞*

üìã *ID –∑–∞—è–≤–∫–∏:* IR-${request.id}
üë§ *–ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä:* ${request.requester}
üíº *–û—Ç–¥–µ–ª:* ${request.department}
üìù *–¢–∏–ø:* ${request.requestType}
‚ö° *–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:* ${request.priority}
${request.walletAddress ? `üíº *–ö–æ—à–µ–ª–µ–∫:* \`${request.walletAddress}\`` : ""}

[–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–µ—Ç–∞–ª–∏](#)
  `.trim();

  const keyboard = Markup.inlineKeyboard([
    [
      Markup.button.callback(
        "üí¨ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ",
        `msg_${request.walletAddress || request.requester}`,
      ),
      Markup.button.callback(
        "üìú –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞",
        `history_${request.walletAddress || request.requester}`,
      ),
    ],
    [Markup.button.url("üìã –î–µ—Ç–∞–ª–∏ –∑–∞—è–≤–∫–∏", `/details IR-${request.id}`)],
  ]);

  await bot.telegram.sendMessage(adminChatId, message, {
    parse_mode: "Markdown",
    ...keyboard,
  });
}

/**
 * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É –æ –Ω–æ–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 */
export async function notifyAdminNewMessage(userWallet: string, messageText: string) {
  const adminChatId = process.env.TELEGRAM_ADMIN_CHAT_ID;
  if (!adminChatId) return;

  const message = `
üí¨ *–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è*

üë§ *–ö–æ—à–µ–ª–µ–∫:* \`${userWallet}\`
üí¨ *–°–æ–æ–±—â–µ–Ω–∏–µ:*
${messageText.substring(0, 500)}${messageText.length > 500 ? "..." : ""}
  `.trim();

  const keyboard = Markup.inlineKeyboard([
    [
      Markup.button.callback("üí¨ –û—Ç–≤–µ—Ç–∏—Ç—å", `reply_${userWallet}`),
      Markup.button.callback("üìú –ò—Å—Ç–æ—Ä–∏—è", `history_${userWallet}`),
    ],
  ]);

  await bot.telegram.sendMessage(adminChatId, message, {
    parse_mode: "Markdown",
    ...keyboard,
  });
}
```

---

### –≠—Ç–∞–ø 3: API endpoints (4-5 —á–∞—Å–æ–≤)

#### 3.1. –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º

**–§–∞–π–ª:** `app/api/support/send-user-message/route.ts`

```typescript
import { NextRequest, NextResponse } from "next/server";
import { query } from "@/lib/database/db";
import { notifyAdminNewMessage } from "@/lib/telegram/notify-admin";

export async function POST(request: NextRequest) {
  try {
    const { walletAddress, text, sessionId } = await request.json();

    if (!walletAddress || !text) {
      return NextResponse.json({ error: "Missing walletAddress or text" }, { status: 400 });
    }

    // –ü–æ–ª—É—á–∏—Ç—å –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å —Å–µ—Å—Å–∏—é
    let session = sessionId;
    if (!session) {
      const sessionResult = await query(
        `INSERT INTO chatbot_sessions (user_wallet_address) 
         VALUES ($1) 
         ON CONFLICT (user_wallet_address) 
         DO UPDATE SET updated_at = CURRENT_TIMESTAMP
         RETURNING id`,
        [walletAddress],
      );
      session = sessionResult.rows[0].id;
    }

    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
    const result = await query(
      `INSERT INTO support_messages 
       (session_id, user_wallet_address, type, text, is_read) 
       VALUES ($1, $2, 'user', $3, FALSE)
       RETURNING *`,
      [session, walletAddress, text],
    );

    const message = result.rows[0];

    // –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É –≤ Telegram
    await notifyAdminNewMessage(walletAddress, text);

    // –û–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
    await query(
      `UPDATE chatbot_sessions 
       SET unread_count = unread_count + 1,
           updated_at = CURRENT_TIMESTAMP
       WHERE id = $1`,
      [session],
    );

    return NextResponse.json({ success: true, message });
  } catch (error) {
    console.error("Error sending user message:", error);
    return NextResponse.json({ error: "Failed to send message" }, { status: 500 });
  }
}
```

#### 3.2. –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –∞–¥–º–∏–Ω–æ–º

**–§–∞–π–ª:** `app/api/support/send-admin-message/route.ts`

```typescript
import { NextRequest, NextResponse } from "next/server";
import { query } from "@/lib/database/db";

export async function POST(request: NextRequest) {
  try {
    const { walletAddress, text, adminId, adminUsername, sessionId } = await request.json();

    if (!walletAddress || !text || !adminId) {
      return NextResponse.json({ error: "Missing required fields" }, { status: 400 });
    }

    // –ü–æ–ª—É—á–∏—Ç—å —Å–µ—Å—Å–∏—é
    let session = sessionId;
    if (!session) {
      const sessionResult = await query(
        `SELECT id FROM chatbot_sessions 
         WHERE user_wallet_address = $1 
         ORDER BY updated_at DESC LIMIT 1`,
        [walletAddress],
      );
      session = sessionResult.rows[0]?.id;
    }

    if (!session) {
      return NextResponse.json({ error: "Session not found" }, { status: 404 });
    }

    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
    const result = await query(
      `INSERT INTO support_messages 
       (session_id, user_wallet_address, type, text, admin_id, admin_username, is_read) 
       VALUES ($1, $2, 'admin', $3, $4, $5, FALSE)
       RETURNING *`,
      [session, walletAddress, text, adminId, adminUsername || null],
    );

    const message = result.rows[0];

    // –û–±–Ω–æ–≤–∏—Ç—å —Å–µ—Å—Å–∏—é
    await query(
      `UPDATE chatbot_sessions 
       SET last_admin_message_at = CURRENT_TIMESTAMP,
           updated_at = CURRENT_TIMESTAMP
       WHERE id = $1`,
      [session],
    );

    // –£–¥–∞–ª–∏—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∞–Ω–∏—è
    await query(
      `DELETE FROM typing_indicators 
       WHERE user_wallet_address = $1 AND admin_id = $2`,
      [walletAddress, adminId],
    );

    return NextResponse.json({ success: true, message });
  } catch (error) {
    console.error("Error sending admin message:", error);
    return NextResponse.json({ error: "Failed to send message" }, { status: 500 });
  }
}
```

#### 3.3. –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π (–æ–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π)

**–§–∞–π–ª:** `app/api/support/get-messages/route.ts`

```typescript
import { NextRequest, NextResponse } from "next/server";
import { query } from "@/lib/database/db";

export async function GET(request: NextRequest) {
  try {
    const searchParams = request.nextUrl.searchParams;
    const walletAddress = searchParams.get("walletAddress");
    const sessionId = searchParams.get("sessionId");

    if (!walletAddress) {
      return NextResponse.json({ error: "Missing walletAddress" }, { status: 400 });
    }

    // –ü–æ–ª—É—á–∏—Ç—å —Å–µ—Å—Å–∏—é
    let session = sessionId;
    if (!session) {
      const sessionResult = await query(
        `SELECT id FROM chatbot_sessions 
         WHERE user_wallet_address = $1 
         ORDER BY updated_at DESC LIMIT 1`,
        [walletAddress],
      );
      session = sessionResult.rows[0]?.id;
    }

    if (!session) {
      return NextResponse.json({ messages: [] });
    }

    // –ü–æ–ª—É—á–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è
    const result = await query(
      `SELECT id, type, text, admin_username, created_at, is_read
       FROM support_messages
       WHERE session_id = $1
       ORDER BY created_at ASC`,
      [session],
    );

    // –û—Ç–º–µ—Ç–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
    await query(
      `UPDATE support_messages 
       SET is_read = TRUE 
       WHERE session_id = $1 AND type = 'admin' AND is_read = FALSE`,
      [session],
    );

    // –û–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
    await query(
      `UPDATE chatbot_sessions 
       SET unread_count = 0
       WHERE id = $1`,
      [session],
    );

    return NextResponse.json({
      messages: result.rows,
      sessionId: session,
    });
  } catch (error) {
    console.error("Error getting messages:", error);
    return NextResponse.json({ error: "Failed to get messages" }, { status: 500 });
  }
}
```

#### 3.4. –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ –¥–ª—è Telegram

**–§–∞–π–ª:** `app/api/support/get-chat-history/route.ts`

```typescript
import { NextRequest, NextResponse } from "next/server";
import { query } from "@/lib/database/db";

export async function GET(request: NextRequest) {
  try {
    const searchParams = request.nextUrl.searchParams;
    const walletAddress = searchParams.get("walletAddress");
    const limit = parseInt(searchParams.get("limit") || "10");

    if (!walletAddress) {
      return NextResponse.json({ error: "Missing walletAddress" }, { status: 400 });
    }

    // –ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    const result = await query(
      `SELECT 
         sm.id, 
         sm.type, 
         sm.text, 
         sm.admin_username,
         sm.created_at,
         cs.user_wallet_address
       FROM support_messages sm
       JOIN chatbot_sessions cs ON sm.session_id = cs.id
       WHERE cs.user_wallet_address = $1
       ORDER BY sm.created_at DESC
       LIMIT $2`,
      [walletAddress, limit],
    );

    // –ü–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç—å –ø–æ—Ä—è–¥–æ–∫ –¥–ª—è —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    const messages = result.rows.reverse();

    return NextResponse.json({ messages });
  } catch (error) {
    console.error("Error getting chat history:", error);
    return NextResponse.json({ error: "Failed to get chat history" }, { status: 500 });
  }
}
```

#### 3.5. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–º "–ø–µ—á–∞—Ç–∞–µ—Ç"

**–§–∞–π–ª:** `app/api/support/set-typing/route.ts`

```typescript
import { NextRequest, NextResponse } from "next/server";
import { query } from "@/lib/database/db";

export async function POST(request: NextRequest) {
  try {
    const { walletAddress, adminId, adminUsername, isTyping } = await request.json();

    if (!walletAddress || !adminId) {
      return NextResponse.json({ error: "Missing walletAddress or adminId" }, { status: 400 });
    }

    if (isTyping) {
      // –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –¥–ª—è —ç—Ç–æ–≥–æ –∞–¥–º–∏–Ω–∞
      await query(
        `DELETE FROM typing_indicators 
         WHERE user_wallet_address = $1 AND admin_id = $2`,
        [walletAddress, adminId],
      );

      // –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
      await query(
        `INSERT INTO typing_indicators 
         (user_wallet_address, admin_id, admin_username, is_typing, expires_at)
         VALUES ($1, $2, $3, TRUE, NOW() + INTERVAL '30 seconds')
         ON CONFLICT DO NOTHING`,
        [walletAddress, adminId, adminUsername || null],
      );
    } else {
      // –£–¥–∞–ª–∏—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
      await query(
        `DELETE FROM typing_indicators 
         WHERE user_wallet_address = $1 AND admin_id = $2`,
        [walletAddress, adminId],
      );
    }

    return NextResponse.json({ success: true });
  } catch (error) {
    console.error("Error setting typing status:", error);
    return NextResponse.json({ error: "Failed to set typing status" }, { status: 500 });
  }
}
```

**–§–∞–π–ª:** `app/api/support/get-typing-status/route.ts`

```typescript
import { NextRequest, NextResponse } from "next/server";
import { query } from "@/lib/database/db";

export async function GET(request: NextRequest) {
  try {
    const searchParams = request.nextUrl.searchParams;
    const walletAddress = searchParams.get("walletAddress");

    if (!walletAddress) {
      return NextResponse.json({ error: "Missing walletAddress" }, { status: 400 });
    }

    // –û—á–∏—Å—Ç–∏—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
    await query(`DELETE FROM typing_indicators WHERE expires_at < NOW()`);

    // –ü–æ–ª—É—á–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
    const result = await query(
      `SELECT admin_id, admin_username, started_at
       FROM typing_indicators
       WHERE user_wallet_address = $1 AND is_typing = TRUE
       ORDER BY started_at DESC
       LIMIT 1`,
      [walletAddress],
    );

    if (result.rows.length > 0) {
      return NextResponse.json({
        isTyping: true,
        adminUsername: result.rows[0].admin_username || "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä",
      });
    }

    return NextResponse.json({ isTyping: false });
  } catch (error) {
    console.error("Error getting typing status:", error);
    return NextResponse.json({ error: "Failed to get typing status" }, { status: 500 });
  }
}
```

---

### –≠—Ç–∞–ø 4: –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ Telegram –±–æ—Ç–∞ (5-6 —á–∞—Å–æ–≤)

#### 4.1. –û–±—Ä–∞–±–æ—Ç–∫–∞ callback –∫–Ω–æ–ø–æ–∫

**–§–∞–π–ª:** `app/api/telegram-webhook/route.ts` (–¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏)

```typescript
// –û–±—Ä–∞–±–æ—Ç–∫–∞ callback "–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ"
bot.action(/^msg_(.+)/, async (ctx) => {
  const walletAddress = ctx.match[1];

  // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ —Å–µ—Å—Å–∏—é –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞
  pendingReplies.set(ctx.chat.id.toString(), {
    walletAddress,
    sessionId: null,
  });

  ctx.answerCbQuery();
  ctx.reply(
    `üí¨ –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é\n\n` +
      `–ö–æ—à–µ–ª–µ–∫: \`${walletAddress}\`\n\n` +
      `–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å:`,
  );
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ callback "–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞"
bot.action(/^history_(.+)/, async (ctx) => {
  const walletAddress = ctx.match[1];

  try {
    const response = await fetch(
      `${process.env.NEXT_PUBLIC_APP_URL}/api/support/get-chat-history?walletAddress=${walletAddress}&limit=10`,
    );

    if (response.ok) {
      const data = await response.json();
      const messages = data.messages || [];

      if (messages.length === 0) {
        ctx.answerCbQuery();
        ctx.reply("üì≠ –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ –ø—É—Å—Ç–∞");
        return;
      }

      let historyText = `üìú *–ü–æ—Å–ª–µ–¥–Ω–∏–µ ${messages.length} —Å–æ–æ–±—â–µ–Ω–∏–π:*\n\n`;

      messages.forEach((msg: any, index: number) => {
        const sender =
          msg.type === "user" ? "üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å" : `üë®‚Äçüíº ${msg.admin_username || "–ê–¥–º–∏–Ω"}`;
        const date = new Date(msg.created_at).toLocaleString("ru-RU");
        historyText += `${index + 1}. ${sender}\n`;
        historyText += `   ${msg.text.substring(0, 100)}${msg.text.length > 100 ? "..." : ""}\n`;
        historyText += `   üïê ${date}\n\n`;
      });

      ctx.answerCbQuery();
      ctx.reply(historyText, { parse_mode: "Markdown" });
    } else {
      ctx.answerCbQuery();
      ctx.reply("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏");
    }
  } catch (error) {
    console.error("Error getting chat history:", error);
    ctx.answerCbQuery();
    ctx.reply("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏");
  }
});
```

#### 4.2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–±–æ—Ä–∞ —Ç–µ–∫—Å—Ç–∞ (typing indicator)

```typescript
// –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –Ω–∞–±–æ—Ä–∞ —Ç–µ–∫—Å—Ç–∞ –∞–¥–º–∏–Ω–æ–º
const typingTimeouts = new Map<string, NodeJS.Timeout>();

bot.on("text", async (ctx) => {
  // –ü—Ä–æ–≤–µ—Ä–∫–∞, –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–π pending reply
  const pending = pendingReplies.get(ctx.chat.id.toString());

  if (pending) {
    // –ï—Å–ª–∏ –∞–¥–º–∏–Ω –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const walletAddress = pending.walletAddress;

    // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å "–ø–µ—á–∞—Ç–∞–µ—Ç"
    await fetch(`${process.env.NEXT_PUBLIC_APP_URL}/api/support/set-typing`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        walletAddress,
        adminId: ctx.from.id,
        adminUsername: ctx.from.first_name || "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä",
        isTyping: true,
      }),
    });

    // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–∞–π–º–µ—Ä –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
    const timeoutKey = `${ctx.chat.id}_${walletAddress}`;
    if (typingTimeouts.has(timeoutKey)) {
      clearTimeout(typingTimeouts.get(timeoutKey)!);
    }

    typingTimeouts.set(
      timeoutKey,
      setTimeout(async () => {
        // –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
        await fetch(`${process.env.NEXT_PUBLIC_APP_URL}/api/support/send-admin-message`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            walletAddress,
            text: ctx.message.text,
            adminId: ctx.from.id,
            adminUsername: ctx.from.first_name || "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä",
            sessionId: pending.sessionId,
          }),
        });

        // –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ç—É—Å "–ø–µ—á–∞—Ç–∞–µ—Ç"
        await fetch(`${process.env.NEXT_PUBLIC_APP_URL}/api/support/set-typing`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            walletAddress,
            adminId: ctx.from.id,
            isTyping: false,
          }),
        });

        pendingReplies.delete(ctx.chat.id.toString());
        typingTimeouts.delete(timeoutKey);
      }, 2000), // –ó–∞–¥–µ—Ä–∂–∫–∞ 2 —Å–µ–∫—É–Ω–¥—ã –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
    );

    ctx.reply("‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ! –ù–∞–ø–∏—à–∏—Ç–µ —Å–ª–µ–¥—É—é—â–µ–µ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /cancel –¥–ª—è –æ—Ç–º–µ–Ω—ã");
  }
});

// –ö–æ–º–∞–Ω–¥–∞ –æ—Ç–º–µ–Ω—ã
bot.command("cancel", (ctx) => {
  const pending = pendingReplies.get(ctx.chat.id.toString());
  if (pending) {
    pendingReplies.delete(ctx.chat.id.toString());
    ctx.reply("‚ùå –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞");
  } else {
    ctx.reply("–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è");
  }
});
```

---

### –≠—Ç–∞–ø 5: –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ (6-8 —á–∞—Å–æ–≤)

#### 5.1. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏

**–§–∞–π–ª:** `components/support/support-messenger.tsx`

```typescript
"use client";

import { useState, useEffect, useRef } from 'react';
import { useAccount } from 'wagmi';
import { MessageList } from './message-list';
import { MessageInput } from './message-input';
import { TypingIndicator } from './typing-indicator';
import { useSupportMessages } from '@/hooks/use-support-messages';
import { useTypingIndicator } from '@/hooks/use-typing-indicator';
import { useNotificationSound } from '@/hooks/use-notification-sound';

interface SupportMessengerProps {
  onClose?: () => void;
}

export function SupportMessenger({ onClose }: SupportMessengerProps) {
  const { address } = useAccount();
  const { messages, sendMessage, loading } = useSupportMessages(address);
  const { isTyping, adminUsername } = useTypingIndicator(address);
  const { playNotification } = useNotificationSound();
  const messagesEndRef = useRef<HTMLDivElement>(null);

  // –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages]);

  // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–≤—É–∫–∞ –ø—Ä–∏ –Ω–æ–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –æ—Ç –∞–¥–º–∏–Ω–∞
  useEffect(() => {
    const lastMessage = messages[messages.length - 1];
    if (lastMessage?.type === 'admin') {
      playNotification();
    }
  }, [messages, playNotification]);

  const handleSend = async (text: string) => {
    if (!text.trim() || !address) return;
    await sendMessage(text);
  };

  if (!address) {
    return (
      <div className="p-4 text-center text-gray-500">
        –ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫ –¥–ª—è –æ–±—â–µ–Ω–∏—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π
      </div>
    );
  }

  return (
    <div className="flex h-full flex-col">
      {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */}
      <div className="flex items-center justify-between border-b p-4">
        <h2 className="text-lg font-semibold">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞</h2>
        {onClose && (
          <button
            onClick={onClose}
            className="text-gray-500 hover:text-gray-700"
          >
            ‚úï
          </button>
        )}
      </div>

      {/* –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π */}
      <div className="flex-1 overflow-y-auto p-4">
        <MessageList messages={messages} />
        {isTyping && <TypingIndicator adminUsername={adminUsername} />}
        <div ref={messagesEndRef} />
      </div>

      {/* –ü–æ–ª–µ –≤–≤–æ–¥–∞ */}
      <MessageInput onSend={handleSend} disabled={loading} />
    </div>
  );
}
```

#### 5.2. –•—É–∫ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏

**–§–∞–π–ª:** `hooks/use-support-messages.ts`

```typescript
import { useState, useEffect, useCallback } from "react";

interface Message {
  id: string;
  type: "user" | "admin" | "system";
  text: string;
  adminUsername?: string;
  createdAt: string;
  isRead: boolean;
}

export function useSupportMessages(walletAddress?: `0x${string}`) {
  const [messages, setMessages] = useState<Message[]>([]);
  const [loading, setLoading] = useState(false);
  const [sessionId, setSessionId] = useState<string | null>(null);

  // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
  const loadMessages = useCallback(async () => {
    if (!walletAddress) return;

    try {
      const response = await fetch(
        `/api/support/get-messages?walletAddress=${walletAddress}${sessionId ? `&sessionId=${sessionId}` : ""}`,
      );
      if (response.ok) {
        const data = await response.json();
        setMessages(data.messages || []);
        if (data.sessionId) {
          setSessionId(data.sessionId);
        }
      }
    } catch (error) {
      console.error("Error loading messages:", error);
    }
  }, [walletAddress, sessionId]);

  // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
  const sendMessage = useCallback(
    async (text: string) => {
      if (!walletAddress || !text.trim()) return;

      setLoading(true);
      try {
        const response = await fetch("/api/support/send-user-message", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            walletAddress,
            text,
            sessionId,
          }),
        });

        if (response.ok) {
          // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è
          await loadMessages();
        }
      } catch (error) {
        console.error("Error sending message:", error);
      } finally {
        setLoading(false);
      }
    },
    [walletAddress, sessionId, loadMessages],
  );

  // Polling –¥–ª—è –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
  useEffect(() => {
    if (!walletAddress) return;

    loadMessages();
    const interval = setInterval(loadMessages, 3000); // –ö–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã

    return () => clearInterval(interval);
  }, [walletAddress, loadMessages]);

  return {
    messages,
    sendMessage,
    loading,
    refresh: loadMessages,
  };
}
```

#### 5.3. –•—É–∫ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ "–ø–µ—á–∞—Ç–∞–µ—Ç"

**–§–∞–π–ª:** `hooks/use-typing-indicator.ts`

```typescript
import { useState, useEffect } from "react";

export function useTypingIndicator(walletAddress?: `0x${string}`) {
  const [isTyping, setIsTyping] = useState(false);
  const [adminUsername, setAdminUsername] = useState<string>("–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä");

  useEffect(() => {
    if (!walletAddress) return;

    const checkTyping = async () => {
      try {
        const response = await fetch(
          `/api/support/get-typing-status?walletAddress=${walletAddress}`,
        );
        if (response.ok) {
          const data = await response.json();
          setIsTyping(data.isTyping || false);
          if (data.adminUsername) {
            setAdminUsername(data.adminUsername);
          }
        }
      } catch (error) {
        console.error("Error checking typing status:", error);
      }
    };

    checkTyping();
    const interval = setInterval(checkTyping, 1000); // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É

    return () => clearInterval(interval);
  }, [walletAddress]);

  return { isTyping, adminUsername };
}
```

#### 5.4. –•—É–∫ –¥–ª—è –∑–≤—É–∫–æ–≤–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

**–§–∞–π–ª:** `hooks/use-notification-sound.ts`

```typescript
import { useCallback, useRef } from "react";

export function useNotificationSound() {
  const audioRef = useRef<HTMLAudioElement | null>(null);

  const playNotification = useCallback(() => {
    try {
      // –°–æ–∑–¥–∞—Ç—å audio —ç–ª–µ–º–µ–Ω—Ç —Å –∑–≤—É–∫–æ–º –∫–æ–ª–æ–∫–æ–ª—å—á–∏–∫–∞
      if (!audioRef.current) {
        audioRef.current = new Audio("/sounds/notification-bell.mp3");
        audioRef.current.volume = 0.5;
      }
      audioRef.current.play().catch((error) => {
        console.error("Error playing notification sound:", error);
      });
    } catch (error) {
      console.error("Error playing notification:", error);
    }
  }, []);

  return { playNotification };
}
```

---

### –≠—Ç–∞–ø 6: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏ (2-3 —á–∞—Å–∞)

#### 6.1. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤ –ø—Ä–æ—Ñ–∏–ª—å

**–§–∞–π–ª:** `components/profile/support-chat-modal.tsx`

```typescript
"use client";

import { useState } from 'react';
import { SupportMessenger } from '@/components/support/support-messenger';
import { Modal } from '@/components/ui/modal';

interface SupportChatModalProps {
  isOpen: boolean;
  onClose: () => void;
}

export function SupportChatModal({ isOpen, onClose }: SupportChatModalProps) {
  return (
    <Modal isOpen={isOpen} onClose={onClose} title="–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞">
      <SupportMessenger onClose={onClose} />
    </Modal>
  );
}
```

#### 6.2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ EmailIcon –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞

**–§–∞–π–ª:** `components/layout/email-icon.tsx` (–æ–±–Ω–æ–≤–∏—Ç—å)

```typescript
"use client";

import { useState } from 'react';
import { SupportChatModal } from '@/components/profile/support-chat-modal';

export function EmailIcon() {
  const [isChatOpen, setIsChatOpen] = useState(false);

  return (
    <>
      <button
        type="button"
        onClick={() => setIsChatOpen(true)}
        className="dark:bg-dark-surfaceAlt dark:text-dark-foreground dark:hover:bg-dark-surface flex h-8 w-8 items-center justify-center rounded-full bg-surfaceAlt text-foreground transition hover:bg-surface"
        aria-label="Open support chat"
      >
        <svg
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
          stroke="currentColor"
          strokeWidth="1.5"
          strokeLinecap="round"
          strokeLinejoin="round"
        >
          <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" />
          <polyline points="22,6 12,13 2,6" />
        </svg>
      </button>

      <SupportChatModal isOpen={isChatOpen} onClose={() => setIsChatOpen(false)} />
    </>
  );
}
```

---

### –≠—Ç–∞–ø 7: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –Ω–æ–≤—ã—Ö –∑–∞—è–≤–∫–∞—Ö (2-3 —á–∞—Å–∞)

#### 7.1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ API —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏ –Ω–∞ –æ–±–º–µ–Ω

**–§–∞–π–ª:** `app/api/submit-exchange-request/route.ts` (–¥–æ–±–∞–≤–∏—Ç—å)

```typescript
import { notifyNewExchangeRequest } from "@/lib/telegram/notify-admin";

// –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î:
await notifyNewExchangeRequest({
  id: requestId,
  walletAddress: data.walletAddress,
  email: data.email,
  tokenAmount: data.tokenAmount,
  fiatAmount: data.fiatAmount,
});
```

#### 7.2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ API —Å–æ–∑–¥–∞–Ω–∏—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –∑–∞—è–≤–∫–∏

**–§–∞–π–ª:** `app/api/submit-request/route.ts` (–¥–æ–±–∞–≤–∏—Ç—å)

```typescript
import { notifyNewInternalRequest } from "@/lib/telegram/notify-admin";

// –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î:
await notifyNewInternalRequest({
  id: requestId,
  requester: data.requester,
  walletAddress: data.walletAddress,
  department: data.department,
  requestType: data.requestType,
  priority: data.priority,
});
```

---

## üé® UI/UX —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —á–∞—Ç–∞

- **–î–∏–∑–∞–π–Ω:** –°—Ç–∏–ª—å –∫–∞–∫ —É —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ chat-window.tsx
- **–†–∞–∑–º–µ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π:**
  - –°–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: —Å–ø—Ä–∞–≤–∞, —Å–∏–Ω–∏–π —Ü–≤–µ—Ç
  - –°–æ–æ–±—â–µ–Ω–∏—è –∞–¥–º–∏–Ω–∞: —Å–ª–µ–≤–∞, —Å–µ—Ä—ã–π —Ü–≤–µ—Ç
  - –ü–æ–∫–∞–∑ –∏–º–µ–Ω–∏ –∞–¥–º–∏–Ω–∞ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –∞–¥–º–∏–Ω–∞
  - Timestamp –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è

### –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä "–ø–µ—á–∞—Ç–∞–µ—Ç"

- –ê–Ω–∏–º–∞—Ü–∏—è –∏–∑ —Ç—Ä–µ—Ö —Ç–æ—á–µ–∫
- –¢–µ–∫—Å—Ç: "{–ò–º—è –∞–¥–º–∏–Ω–∞} –ø–µ—á–∞—Ç–∞–µ—Ç..."
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥

### –ó–≤—É–∫–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ

- –ó–≤—É–∫: –∫–æ–ª–æ–∫–æ–ª—å—á–∏–∫ (notification-bell.mp3)
- –ì—Ä–æ–º–∫–æ—Å—Ç—å: 50%
- –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –∞–¥–º–∏–Ω–∞

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ü—Ä–æ–≤–µ—Ä–∫–∏

1. **–í–∞–ª–∏–¥–∞—Ü–∏—è walletAddress:**
   - –§–æ—Ä–º–∞—Ç: `0x[0-9a-fA-F]{40}`
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞

2. **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∞–¥–º–∏–Ω–∞:**
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ `TELEGRAM_ADMIN_CHAT_ID` –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
   - –í–∞–ª–∏–¥–∞—Ü–∏—è `adminId` –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏–π

3. **Rate limiting:**
   - –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–æ–æ–±—â–µ–Ω–∏–π: 10 –≤ –º–∏–Ω—É—Ç—É –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏—è: 2000 —Å–∏–º–≤–æ–ª–æ–≤

4. **Sanitization:**
   - –û—á–∏—Å—Ç–∫–∞ HTML —Ç–µ–≥–æ–≤ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏–π
   - –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤

---

## üìù –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–î–æ–±–∞–≤–∏—Ç—å –≤ `.env.local`:

```env
# Telegram
TELEGRAM_API_KEY=your_telegram_bot_token
TELEGRAM_ADMIN_CHAT_ID=your_admin_chat_id
TELEGRAM_WEBHOOK_URL=https://yourdomain.com/api/telegram-webhook

# App
NEXT_PUBLIC_APP_URL=http://localhost:3000
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ß–µ–∫–ª–∏—Å—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

- [ ] –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞—è–≤–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram
- [ ] –ö–Ω–æ–ø–∫–∞ "–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ" –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –¥–∏–∞–ª–æ–≥ –æ—Ç–ø—Ä–∞–≤–∫–∏
- [ ] –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∞–¥–º–∏–Ω–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –Ω–∞ —Å–∞–π—Ç–µ
- [ ] –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏—Ö–æ–¥–∏—Ç –∞–¥–º–∏–Ω—É –≤ Telegram
- [ ] –ö–Ω–æ–ø–∫–∞ "–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞" –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π
- [ ] –°—Ç–∞—Ç—É—Å "–ø–µ—á–∞—Ç–∞–µ—Ç..." –ø–æ—è–≤–ª—è–µ—Ç—Å—è –∏ –∏—Å—á–µ–∑–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –ó–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –ø—Ä–∏ –Ω–æ–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
- [ ] –ù–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç–º–µ—á–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∏–∫–æ–Ω–∫—É –∫–æ–Ω–≤–µ—Ä—Ç–∞
- [ ] –°–æ–æ–±—â–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î –∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## üìÖ –í—Ä–µ–º–µ–Ω–Ω—ã–µ –æ—Ü–µ–Ω–∫–∏

| –≠—Ç–∞–ø      | –í—Ä–µ–º—è       | –û–ø–∏—Å–∞–Ω–∏–µ                 |
| --------- | ----------- | ------------------------ |
| –≠—Ç–∞–ø 1    | 1-2 —á       | –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –ë–î            |
| –≠—Ç–∞–ø 2    | 2-3 —á       | –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è Telegram     |
| –≠—Ç–∞–ø 3    | 4-5 —á       | API endpoints            |
| –≠—Ç–∞–ø 4    | 5-6 —á       | –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ Telegram –±–æ—Ç–∞ |
| –≠—Ç–∞–ø 5    | 6-8 —á       | –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞     |
| –≠—Ç–∞–ø 6    | 2-3 —á       | –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è               |
| –≠—Ç–∞–ø 7    | 2-3 —á       | –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–∞—è–≤–∫–∞—Ö    |
| **–ò—Ç–æ–≥–æ** | **22-30 —á** | –ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è        |

---

## üöÄ –ü–ª–∞–Ω –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

### –§–∞–∑–∞ 1: –ë–∞–∑–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å (7-10 —á–∞—Å–æ–≤)

- –≠—Ç–∞–ø 1-3: –ë–î + API endpoints
- –ë–∞–∑–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π

### –§–∞–∑–∞ 2: Telegram –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (7-10 —á–∞—Å–æ–≤)

- –≠—Ç–∞–ø 4: –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –±–æ—Ç–∞
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–∞—è–≤–∫–∞—Ö
- –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ Telegram

### –§–∞–∑–∞ 3: UI –∏ UX (8-13 —á–∞—Å–æ–≤)

- –≠—Ç–∞–ø 5-6: –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
- –°—Ç–∞—Ç—É—Å "–ø–µ—á–∞—Ç–∞–µ—Ç..."
- –ó–≤—É–∫–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [Telegraf Documentation](https://telegraf.js.org/)
- [PostgreSQL Triggers](https://www.postgresql.org/docs/current/triggers.html)
- [Server-Sent Events](https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events)
- [Web Audio API](https://developer.mozilla.org/en-US/docs/Web/API/Web_Audio_API)

---

**–í–µ—Ä—Å–∏—è –ø–ª–∞–Ω–∞:** 1.0  
**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-01-30  
**–°—Ç–∞—Ç—É—Å:** –ì–æ—Ç–æ–≤ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
